{% extends "issues/base.html" %}
{% load gravatar %}

{% block title %}Issues for {{ object }}{% endblock %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/project_detail.css" />

    <style>
    {% for tagcss in tags %}
        .tag_{{ tagcss.pk }}
        { background-color: #{{ tagcss.color}} ; }        
    {% endfor %}
    </style>

{% endblock %}

{% block js %}
    {{ block.super }}
    <script type="text/javascript" src="{{ STATIC_URL }}js/project_detail.js"></script>

    <script type="text/javascript">
        var new_tag_line =  $("{% filter escapejs %}{% spaceless %}{% include 'issues/tag_line.html' %}{% endspaceless %}{% endfilter %}");
        var project_slug = "{{ project.slug }}";
        var current_user = "{{ user.pk }}";
        var current_user_name = "{{ user.get_full_name }}";
        UPDATE_ISSUE_URL  = '{% url project_detail project.slug %}';
        CREATE_NOTE_URL   = '{% url note_create_view project.slug %}';
        CREATE_COMMIT_URL = '{% url commit_create_view project.slug %}';
        SORT_ISSUE_URL    = '{% url sort_issue project.slug %}';

        var milestone_dates = [
        {% for milestone in project.future_milestones %}
            "{{ milestone }}",
        {% endfor %}
        ];
    </script>

{% endblock %}

{% block content %}
    {{ block.super }}
    {% csrf_token %}
    
    <section id="project-detail">
        {% if project.get_scm_url %}
            <a class="right" href="{{ project.get_scm_url }}" target="_blank">View Source Project</a>
        {% endif %}
        <h3>{{ object }}</h3>

        <button type = "button" id="new-issue-button"> Add Issue </button>


        <div class="right">
            <label>Filter:</label>
            <select id="issue_filter" data-pj="{{ project.slug }}">
              <option value="ALL" {% if filter = 'OPEN' %} selected {% endif %}>Open</option>
              <option value="IP" {% if filter = 'IP' %} selected {% endif %}>In Progress</option>
              <option value="AS" {% if filter = 'AS' %} selected {% endif %}>Assigned</option>
              <option value="UA" {% if filter = 'UA' %} selected {% endif %}>Unassigned</option>
              <option value="CP" {% if filter = 'CP' %} selected {% endif %}>Completed</option>
              <option value="DL" {% if filter = 'DL' %} selected {% endif %}>Deleted</option>
            </select>
        </div>

        
        {% include 'issues/issue_new.html' %}
        {% include 'issues/color_selector.html' %}
        <div class="needs-review-issues">
            <ul class="issue-list">

                {% for issue in project.needs_review_issues %}
                    {% if issue.assigned_to != user %}
                     <li id="issue-nr-{{ issue.pk }}" class="issue needs-review">
                        <span class="assigned-to">
                            {% if issue.assigned_to %}
                                {% if issue.assigned_to.get_full_name %}
                                    <a href="{% url user_profile_view user_id=issue.assigned_to.pk %}">{{ issue.assigned_to.get_full_name }}</a>
                                {% else %}
                                    <a href="{% url user_profile_view user_id=issue.assigned_to.pk %}">{{ issue.assigned_to }}</a>
                                {% endif %}
                              <img src= "{{ issue.assigned_to.email|gravatar }}" width=32 height=32>
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </span>

                            <span class="issue-nr-title" title="{{ issue.description }}" rel="#issue-details-{{ issue.pk }}">{{ issue }}</span>
                          
                            <div class = "tag_list">
                              {% for tag in issue.tags.all %}
                                <div class = "tag tag_{{ tag.pk }}">{{ tag.label }}</div>
                              {% endfor %}
                            </div>

                                {% include 'issues/issue_view.html' %}
                          <div style = "clear: both;"></div>
                        </li>
                    {% endif %}
                {% endfor %}

            </ul>
        </div>
        <ul class="issue-list">
        {% for issue in issues %}
	  <li id="issue-{{ issue.pk }}"
	      {% if issue.assigned_to %}
		{% if issue.assigned_to == user and issue.status = 'IP'%}
		  class="issue in-progress"
		  {% elif issue.assigned_to == user and issue.status = 'AS' %}
		  class="issue assigned"
		{% else %}
		  class="issue unassigned"
		{% endif %}
	      {% else %}
		class="issue unassigned"
	      {% endif %}
	      >

	      {% include 'issues/includes/issue_detail.html' %}
	      {% include 'issues/issue_view.html' %}
	      {% include 'issues/issue_edit.html' %}
	      <div style = "clear: both;"></div>
	  </li>
        {% endfor %}
        </ul>
    </section>
{% endblock %}
